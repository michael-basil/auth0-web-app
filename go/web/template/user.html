<!-- web/template/user.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>User</title>
    <script src="/public/js/js.cookie.js"></script>
    <script src="/public/js/user.js"></script>
  </head>
  <body>
    <div>
      <img class="avatar" src="{{ index .Profile "picture" }}" />
      <h2>Welcome {{ index .Profile "nickname" }}</h2>
      <button class="btn-logout" onclick="window.location.href='/logout'">
        Logout
      </button>
      <button onclick="window.location.href='/userinfo'">
        Call /userinfo
      </button>
      <button id="refresh-button">Refresh Tokens</button>
    </div>
    <section>
      <h3>ID Token Claims</h3>
      <pre>{{ .Pretty }}</pre>
    </section>
    <script>
      const refreshButton = document.getElementById('refresh-button');
      refreshButton.addEventListener('click', () => {
        fetch('/refresh', { method: 'POST' })
          .then(async (response) => {
            const text = await response.text();
            try {
              const json = JSON.parse(text);
              return response.ok
                ? json
                : Promise.reject(json.error || json.message || text);
            } catch {
              if (response.ok) {
                return text;
              }
              return Promise.reject(text || 'Unexpected error');
            }
          })
          .then((data) => {
            const message =
              typeof data === 'object'
                ? JSON.stringify(data, null, 2)
                : String(data);
            alert(message);
          })
          .catch((err) => {
            alert(`Refresh failed: ${err}`);
          });
      });
    </script>
  </body>
</html>
